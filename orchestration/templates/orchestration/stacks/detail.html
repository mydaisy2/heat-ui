{% extends 'orchestration/base.html' %}
{% load i18n sizeformat %}
{% block title %}{% trans "Stack Detail" %}{% endblock %}

{% block page_header %}
  {% include "horizon/common/_page_header.html" with title=title %}
{% endblock page_header %}

{% block heatContent %}
<div class="row-fluid">
  <div class="span12">
  {{ tab_group.render }}
  </div>
</div>
{% endblock %}

{% block heatjs %}
<script>
var width = $("#topology").width(),
    height = 500;

var d3_data = $("#d3_data").data("d3_data");

var force = d3.layout.force()
    .charge(-400)
    .linkDistance(150)
    .size([width, height])

var svg = d3.select("#topology").append("svg")
    .attr("width", width)
    .attr("height", height);

var graph = d3_data;

force.nodes(graph.nodes)
     .links(graph.links)
     .start();

var link = svg.selectAll(".link")
        .data(graph.links)
        .enter().append("line")
        .attr("class", "link")
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });

var node = svg.selectAll(".node")
        .data(graph.nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("node_name", function(d){ return d.name })
        .call(force.drag);

var node_image = node.append("image")
        .attr("xlink:href", function(d) { return d.image; })
        .attr("x", function(d) { return d.image_x; })
        .attr("y", function(d) { return d.image_y; })
        .attr("width", function(d) { return d.image_size; })
        .attr("height", function(d) { return d.image_size; });

node.append("text")
        .attr("dx", function(d) { return d.text_x; })
        .attr("dy", function(d) { return d.text_y; })
        .text(function(d) { return d.name; });

//Build node dictionary
var nodes = {};
node.each(function(){
   d = this.__data__;
   nodes[d.name] = this;
});

//Build node image dictionary
var node_images = {};
node_image.each(function(){
   d = this.__data__;
   node_images[d.name] = this;
});

//Load initial info box, and setup to change on click
$("#info_box").html(graph.nodes[0].info_box);
var current_info = graph.nodes[0].name;
node.on("click", function(d) {
   $("#info_box").html(d.info_box);
    current_info = d.name;
});

force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
});


//On Page load, set Action In Progress
var in_progress = false;
set_in_progress();

function set_in_progress() {
  node.each(function() {
       var d = this.__data__;
       if (d.in_progress == true){
           in_progress = true;
           return false;
       }
  });
}

//If status is In Progress, start AJAX polling
if (in_progress == true){
    var d3_url = '/heat/stack/get_d3_data/'+graph.nodes[0].stack_id+'/';

    var ajax_poll = setInterval(function() {
        $.getJSON(d3_url, function(json) {
            var still_in_progress = false;
            json.nodes.forEach(function(d){
                //Update each nodes status, info_box, and image
                nodes[d.name].__data__.status = d.status;

                //Status has changed, image should be updated
                if (node_images[d.name].__data__.image != d.image){
                    node_images[d.name].__data__.image = d.image;
                    var this_image = d3.select(node_images[d.name]);
                    this_image
                            .transition()
                            .attr("x", function(d) { return d.image_x + 5; })
                            .duration(100)
                            .transition()
                            .attr("x", function(d) { return d.image_x - 5; })
                            .duration(100)
                            .transition()
                            .attr("x", function(d) { return d.image_x + 5; })
                            .duration(100)
                            .transition()
                            .attr("x", function(d) { return d.image_x - 5; })
                            .duration(100)
                            .transition()
                            .attr("xlink:href", d.image)
                            .transition()
                            .attr("x", function(d) { return d.image_x; })
                            .duration(100)
                            .ease("bounce")
                }

                //Status has changed, update info_box
                nodes[d.name].__data__.info_box = d.info_box;
                if (current_info== d.name){
                    $("#info_box").html(d.info_box);
                }

                //Check if ANY nodes still in progress
                if (d.in_progress==true){
                    still_in_progress = true;
                }
            });

            //if no nodes still in progress, stop AJAX polling
            if (still_in_progress==false){
                clearInterval(ajax_poll);
            }
        });
    }, 2500)
}
</script>







{% comment %}/*
//Playing with Transitions, eventually add AJAX
images = [
    "/static/heat/img/stack.png",
    "/static/heat/img/stack_error.png",
    "/static/heat/img/load2.gif",
]

//Shaky/Nervous new image
node_image.each(function() {
   var this_image = d3.select(this);

    setInterval(function() {
        var image_url = images[Math.floor(Math.random()*images.length)];
        this_image.transition()
                .attr("x", function(d) { return d.image_x + 5; })
                .duration(100)
                .transition()
                .attr("x", function(d) { return d.image_x - 5; })
                .duration(100)
                .transition()
                .attr("x", function(d) { return d.image_x + 5; })
                .duration(100)
                .transition()
                .attr("x", function(d) { return d.image_x - 5; })
                .duration(100)
                .transition()
                .attr("xlink:href", image_url)
                .transition()
                .attr("x", function(d) { return d.image_x; })
                .duration(100)
                .ease("bounce")

    }, 5000)

});
*/
//Hide/Show Bouncy new image
/*
node_image.each(function() {
   var this_image = d3.select(this);

    setInterval(function() {
        var image_url = images[Math.floor(Math.random()*images.length)];
        console.log(image_url);
        this_image.transition()
                .attr("width", 0)
                .attr("height", 0)
                .duration(500)
                .ease("bounce")
                .transition()
                .attr("xlink:href", image_url)
                .transition()
                .attr("width",function(d) { return d.image_size; })
                .attr("height",function(d) { return d.image_size; })
                .duration(500)
                .ease("bounce")

    }, 5000)
});
*/



<script>
$(document).ready(function() {
    InitTopology();
});

//Topology code
function InitTopology() {
    /*
    function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
    };
    */
    var cv_width = $("#topology_canvas").width();
    var stage = Heat.Stage({
        container: 'topology_canvas',
        width: cv_width,
        height: 500
    });

    var layer1 = new Heat.Layer({height:Heat.rowHeight});
    var stack = new Heat.Stack({
        stage: stage,
        layer: layer1,
        stack: $("#stack").data("stack")
    });

    var layer2 = new Heat.Layer({height:Heat.rowHeight,y:(layer1.getPosition().y+layer1.getHeight())});
    var resources = $("#resources").data("resources");
    var resource_group = new Heat.Group();
    $.each(resources, function() {
       //alert(this.logical_resource_id);
        resource_group.add(new Heat.Resource({
            resource:this,
            stage:stage,
            layer:layer2
        }));
    });

}
</script>
{% endcomment %}
{% endblock %}
